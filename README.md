First pass, I think its done (actually there are bugs). 
Fey added this line.
Edit for PR
Identify and fix any bugs in the code
