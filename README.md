First pass, I think its done (actually there are bugs). 

Edit for PR
